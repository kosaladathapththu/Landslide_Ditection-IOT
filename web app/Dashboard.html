<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuard IoT | Landslide Detection</title>

    <!-- Tailwind (browser build) -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Chart.js (optional – you can use later) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Glassmorphism & Gradients */
        .glass-panel {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Status Glows */
        .glow-safe { box-shadow: 0 0 20px -5px rgba(16, 185, 129, 0.3); border-color: rgba(16, 185, 129, 0.4); }
        .glow-warning { box-shadow: 0 0 20px -5px rgba(245, 158, 11, 0.3); border-color: rgba(245, 158, 11, 0.4); }
        .glow-danger { box-shadow: 0 0 30px -5px rgba(239, 68, 68, 0.5); border-color: rgba(239, 68, 68, 0.5); }

        /* Animations */
        @keyframes pulse-red {
            0% { opacity: 0.1; }
            50% { opacity: 0.3; }
            100% { opacity: 0.1; }
        }
        .animate-danger-overlay { animation: pulse-red 2s infinite; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
        
        /* Fade In */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(-5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-300 min-h-screen relative overflow-x-hidden">

    <!-- Danger Overlay (Fixed Layer) -->
    <div id="danger-overlay" class="fixed inset-0 bg-rose-900 pointer-events-none opacity-0 transition-opacity duration-500 z-0"></div>

    <!-- Dashboard Container -->
    <div class="w-full max-w-[1920px] mx-auto space-y-8 p-6 md:p-10 relative z-10">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center pb-6 border-b border-zinc-800/50">
            <div>
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-indigo-500/10 rounded-xl border border-indigo-500/20 shadow-[0_0_15px_-3px_rgba(99,102,241,0.2)]">
                        <svg class="w-7 h-7 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-zinc-100 tracking-tight">
                            GeoGuard <span class="text-indigo-500 font-mono text-xl">IoT</span>
                        </h1>
                        <p class="text-xs text-zinc-500 font-mono tracking-wide mt-0.5">
                            ESP8266 NODE • FIREBASE RTDB • MPU ARRAY
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 md:mt-0 flex items-center gap-4">
                <div id="connection-badge" class="flex items-center gap-2.5 px-4 py-2 rounded-full bg-zinc-900/80 border border-zinc-800 text-xs font-medium text-zinc-500 transition-colors shadow-lg">
                    <span class="relative flex h-2.5 w-2.5">
                      <span id="conn-ping" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 hidden"></span>
                      <span id="conn-dot" class="relative inline-flex rounded-full h-2.5 w-2.5 bg-zinc-600"></span>
                    </span>
                    <span id="conn-text">Connecting...</span>
                </div>
                
                <button id="force-danger-btn" class="px-5 py-2 bg-rose-500/10 hover:bg-rose-500/20 text-rose-400 border border-rose-500/20 rounded-lg text-sm font-medium transition-all hover:shadow-[0_0_15px_-3px_rgba(244,63,94,0.3)] cursor-pointer active:scale-95">
                    Simulate Danger
                </button>
            </div>
        </header>

        <!-- Panoramic Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">

            <!-- ROW 1 -->
            
            <!-- 1. Main Status Card (Top Left, 2 cols) -->
            <div id="status-card" class="glass-panel rounded-3xl p-8 md:col-span-2 relative overflow-hidden transition-all duration-500 flex flex-col justify-between min-h-[280px]">
                <div class="absolute top-0 right-0 p-6 opacity-5">
                    <svg class="w-48 h-48" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2L2 22h20L12 2zm0 4l6.5 13h-13L12 6z"/>
                    </svg>
                </div>
                
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <h2 class="text-zinc-500 text-xs font-bold uppercase tracking-[0.2em] mb-1">
                            Fused Risk Analysis
                        </h2>
                        <span id="risk-badge" class="px-2 py-1 rounded bg-zinc-800/50 border border-zinc-700 text-zinc-400 font-mono text-xs">
                            NBRO Logic + ESP Pattern
                        </span>
                    </div>
                    <div id="status-display" class="text-6xl lg:text-7xl font-bold text-emerald-400 tracking-tighter mt-4">
                        SAFE
                    </div>
                </div>
                
                <div class="relative z-10 mt-auto pt-6">
                    <div class="h-1.5 bg-zinc-800/50 rounded-full overflow-hidden mb-3">
                        <div id="risk-bar" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 w-0 transition-all duration-1000 ease-out"></div>
                    </div>
                    <p id="status-msg" class="text-sm text-zinc-400 font-mono border-l-2 border-emerald-500/30 pl-3">
                        Sensors active. No anomalies detected within geofence.
                    </p>
                </div>
            </div>

            <!-- 2. Soil Moisture (Top Middle) -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col justify-between hover:bg-zinc-900/60 transition duration-300 group relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-amber-500/5 rounded-full blur-2xl -mr-4 -mt-4 pointer-events-none"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="p-3 rounded-2xl bg-zinc-900/80 border border-zinc-800 text-amber-400 shadow-inner">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-mono text-zinc-600 uppercase tracking-wider bg-zinc-900/50 px-2 py-1 rounded">
                        Soil Cap
                    </span>
                </div>
                <div class="mt-6 relative z-10">
                    <h4 class="text-zinc-500 text-xs uppercase font-bold tracking-wider">Soil Saturation</h4>
                    <div class="flex items-baseline gap-1 mt-2">
                        <span id="soil-val" class="text-4xl font-bold text-zinc-100 tracking-tight">0</span>
                        <span class="text-lg text-zinc-500 font-medium">%</span>
                    </div>
                    <div class="w-full bg-zinc-800/50 h-2 rounded-full mt-4 overflow-hidden">
                        <div id="soil-bar" class="h-full bg-amber-500 transition-all duration-500 shadow-[0_0_10px_rgba(245,158,11,0.5)]" style="width: 0%"></div>
                    </div>
                    <p id="soil-risk-text" class="text-[10px] text-zinc-500 mt-2 font-mono">
                        Soil risk (ESP): <span class="text-zinc-300">--</span>
                    </p>
                </div>
            </div>

            <!-- 3. Rainfall (Top Right) -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col justify-between hover:bg-zinc-900/60 transition duration-300 group relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-cyan-500/5 rounded-full blur-2xl -mr-4 -mt-4 pointer-events-none"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="p-3 rounded-2xl bg-zinc-900/80 border border-zinc-800 text-cyan-400 shadow-inner">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-mono text-zinc-600 uppercase tracking-wider bg-zinc-900/50 px-2 py-1 rounded">
                        Rain Sensor
                    </span>
                </div>
                <div class="mt-6 relative z-10">
                    <h4 class="text-zinc-500 text-xs uppercase font-bold tracking-wider">Rain Intensity</h4>
                    <div class="flex items-baseline gap-1 mt-2">
                        <span id="rain-val" class="text-4xl font-bold text-zinc-100 tracking-tight">0</span>
                        <span class="text-lg text-zinc-500 font-medium">mm</span>
                    </div>
                    <p id="rain-status" class="text-xs font-mono mt-4 py-1 px-2 rounded bg-zinc-900/50 inline-block border border-zinc-800">
                        NBRO: <span class="text-zinc-400">--</span>
                    </p>
                </div>
            </div>

            <!-- ROW 2 -->

            <!-- 4. MPU Top (Row 2, Col 1) -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col justify-between hover:bg-zinc-900/60 transition duration-300 group relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-indigo-500/5 rounded-full blur-2xl -mr-4 -mt-4 pointer-events-none"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="p-3 rounded-2xl bg-zinc-900/80 border border-zinc-800 text-indigo-400 shadow-inner">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-mono text-zinc-600 uppercase tracking-wider bg-zinc-900/50 px-2 py-1 rounded">
                        MPU-3
                    </span>
                </div>
                <div class="mt-6 relative z-10">
                    <h4 class="text-zinc-500 text-xs uppercase font-bold tracking-wider">Top Sensor</h4>
                    <div class="flex items-baseline gap-1 mt-2">
                        <span id="mpu3-val" class="text-3xl font-bold text-zinc-100 tracking-tight">0.0</span>
                        <span class="text-sm text-zinc-500">deg</span>
                    </div>
                    <div id="mpu3-status" class="text-[10px] font-mono mt-2 text-emerald-400">Stable</div>
                    <div id="mpu3-vib" class="mt-1 text-[10px] font-mono inline-block px-2 py-1 rounded bg-zinc-900/60 border border-zinc-800 text-zinc-400">
                        Vibration: --
                    </div>
                </div>
            </div>

            <!-- 5. MPU Middle (Row 2, Col 2) -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col justify-between hover:bg-zinc-900/60 transition duration-300 group relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-indigo-500/5 rounded-full blur-2xl -mr-4 -mt-4 pointer-events-none"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="p-3 rounded-2xl bg-zinc-900/80 border border-zinc-800 text-indigo-400 shadow-inner">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-mono text-zinc-600 uppercase tracking-wider bg-zinc-900/50 px-2 py-1 rounded">
                        MPU-1
                    </span>
                </div>
                <div class="mt-6 relative z-10">
                    <h4 class="text-zinc-500 text-xs uppercase font-bold tracking-wider">Middle Sensor</h4>
                    <div class="flex items-baseline gap-1 mt-2">
                        <span id="mpu1-val" class="text-3xl font-bold text-zinc-100 tracking-tight">0.0</span>
                        <span class="text-sm text-zinc-500">deg</span>
                    </div>
                    <div id="mpu1-status" class="text-[10px] font-mono mt-2 text-emerald-400">Stable</div>
                    <div id="mpu1-vib" class="mt-1 text-[10px] font-mono inline-block px-2 py-1 rounded bg-zinc-900/60 border border-zinc-800 text-zinc-400">
                        Vibration: --
                    </div>
                </div>
            </div>

            <!-- 6. MPU Bottom (Row 2, Col 3) -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col justify-between hover:bg-zinc-900/60 transition duration-300 group relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-indigo-500/5 rounded-full blur-2xl -mr-4 -mt-4 pointer-events-none"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="p-3 rounded-2xl bg-zinc-900/80 border border-zinc-800 text-indigo-400 shadow-inner">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-mono text-zinc-600 uppercase tracking-wider bg-zinc-900/50 px-2 py-1 rounded">
                        MPU-2
                    </span>
                </div>
                <div class="mt-6 relative z-10">
                    <h4 class="text-zinc-500 text-xs uppercase font-bold tracking-wider">Bottom Sensor</h4>
                    <div class="flex items-baseline gap-1 mt-2">
                        <span id="mpu2-val" class="text-3xl font-bold text-zinc-100 tracking-tight">0.0</span>
                        <span class="text-sm text-zinc-500">deg</span>
                    </div>
                    <div id="mpu2-status" class="text-[10px] font-mono mt-2 text-emerald-400">Stable</div>
                    <div id="mpu2-vib" class="mt-1 text-[10px] font-mono inline-block px-2 py-1 rounded bg-zinc-900/60 border border-zinc-800 text-zinc-400">
                        Vibration: --
                    </div>
                </div>
            </div>

            <!-- 7. Environment (Row 2, Col 4) -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col justify-between hover:bg-zinc-900/60 transition duration-300 group relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-500/5 rounded-full blur-2xl -mr-4 -mt-4 pointer-events-none"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="p-3 rounded-2xl bg-zinc-900/80 border border-zinc-800 text-emerald-400 shadow-inner">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-mono text-zinc-600 uppercase tracking-wider bg-zinc-900/50 px-2 py-1 rounded">
                        DHT22
                    </span>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-4 relative z-10">
                    <div class="bg-zinc-900/40 p-3 rounded-xl border border-zinc-800/50">
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Temp</div>
                        <div class="text-xl font-bold text-zinc-100 mt-1">
                            <span id="temp-val">--</span>°C
                        </div>
                    </div>
                    <div class="bg-zinc-900/40 p-3 rounded-xl border border-zinc-800/50">
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Humid</div>
                        <div class="text-xl font-bold text-zinc-100 mt-1">
                            <span id="humid-val">--</span>%
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW 3 -->

            <!-- 8. Alert Log (Bottom, 2 cols) -->
            <div class="glass-panel rounded-3xl p-0 md:col-span-2 flex flex-col min-h-[240px]">
                <div class="p-5 border-b border-zinc-800 bg-zinc-900/30 flex justify-between items-center rounded-t-3xl">
                    <h3 class="text-zinc-300 font-semibold text-sm flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Decision Log
                    </h3>
                    <button id="clear-log" class="text-[10px] uppercase tracking-wider text-zinc-600 hover:text-zinc-300 transition px-2 py-1 border border-zinc-800 rounded hover:bg-zinc-800">
                        Clear
                    </button>
                </div>
                <div id="alert-log" class="flex-1 overflow-y-auto p-5 space-y-3 font-mono text-xs">
                    <div class="flex gap-3 text-zinc-600">
                        <span>--:--:--</span>
                        <span>System Initialized. Waiting for stream...</span>
                    </div>
                </div>
            </div>

            <!-- 9. Research/Logic Table (Bottom, 2 cols) -->
            <div class="glass-panel rounded-3xl p-6 md:col-span-2 text-xs text-zinc-400 overflow-hidden">
                <h3 class="text-zinc-200 font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    Logic Matrix & Thresholds
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-[10px] uppercase tracking-widest text-indigo-400 mb-2 font-bold">NBRO Rainfall</h4>
                        <ul class="space-y-1.5 border-l border-zinc-800 pl-3">
                            <li class="flex justify-between"><span>Watch</span> <span class="text-zinc-300">&gt;75mm/day</span></li>
                            <li class="flex justify-between"><span>Alert</span> <span class="text-zinc-300">&gt;100mm/day</span></li>
                            <li class="flex justify-between"><span>Evacuate</span> <span class="text-rose-400 font-bold">&gt;120mm/day</span></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-[10px] uppercase tracking-widest text-amber-400 mb-2 font-bold">Soil vs. Slope</h4>
                        <table class="w-full text-left opacity-80">
                            <tr class="border-b border-zinc-800/50"><td class="py-1">20-40% + &gt;25°</td><td class="text-amber-400 text-right">Mod</td></tr>
                            <tr class="border-b border-zinc-800/50"><td class="py-1">40-60% + &gt;25°</td><td class="text-orange-400 text-right">High</td></tr>
                            <tr><td class="py-1">&gt;60% + &gt;15°</td><td class="text-rose-500 text-right font-bold">Critical</td></tr>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <footer class="text-center text-[10px] text-zinc-700 py-8 font-mono uppercase tracking-widest">
            &copy; 2023 GeoGuard Systems | NodeMCU ESP8266 Integration | NBRO Standards
        </footer>

    </div>

    <!-- ===================== FIREBASE + LOGIC SCRIPT ===================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSEWW0wawOzJgvxyOmDqXMqE8nihprCd0",
            authDomain: "iot-project-3c897.firebaseapp.com",
            databaseURL: "https://iot-project-3c897-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "iot-project-3c897",
            storageBucket: "iot-project-3c897.firebasestorage.app",
            messagingSenderId: "876143785284",
            appId: "1:876143785284:web:3435ff5210b9ea92475311",
            measurementId: "G-X44B4KWT65"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- APP STATE ---
        let appState = {
            sensors: {
                mpu1: 0,
                mpu2: 0,
                mpu3: 0,
                vib1: "Low",
                vib2: "Low",
                vib3: "Low",
                soil: 0,
                rain: 0,
                temp: 0,
                humid: 0
            },
            status: "SAFE",
            lastUpdate: Date.now(),
            landslide: false,        // ESP landslide flag
            soilRiskText: "--"       // from ESP SoilRisk
        };

        // --- FIREBASE LISTENER (PATH = sensor_data) ---
        const sensorsRef = ref(db, "sensor_data");

        onValue(
            sensorsRef,
            (snapshot) => {
                const data = snapshot.val();
                updateConnectionStatus(true);

                if (data) {
                    appState.sensors.mpu1 = parseFloat(data.MPU1_Tilt ?? 0);
                    appState.sensors.mpu2 = parseFloat(data.MPU2_Tilt ?? 0);
                    appState.sensors.mpu3 = parseFloat(data.MPU3_Tilt ?? 0);

                    appState.sensors.vib1 = (data.MPU1_Vibration ?? "Low").toString();
                    appState.sensors.vib2 = (data.MPU2_Vibration ?? "Low").toString();
                    appState.sensors.vib3 = (data.MPU3_Vibration ?? "Low").toString();

                    appState.sensors.soil = parseFloat(data.SoilPercent ?? data.Soil ?? 0);
                    appState.sensors.rain = parseFloat(data.RainMM ?? data.Rain ?? 0);

                    appState.sensors.temp  = parseFloat(data.Temperature ?? 0);
                    appState.sensors.humid = parseFloat(data.Humidity ?? 0);

                    const landRaw = (data.Landslide ?? "NO").toString().toUpperCase();
                    appState.landslide = (landRaw === "YES");

                    appState.soilRiskText = (data.SoilRisk ?? "--").toString();

                    appState.lastUpdate = Date.now();
                    processSensorData();
                }
            },
            (error) => {
                console.error("Firebase Read Error:", error);
                updateConnectionStatus(false);
            }
        );

        // --- CONNECTION BADGE ---
        function updateConnectionStatus(connected) {
            const dot = document.getElementById("conn-dot");
            const ping = document.getElementById("conn-ping");
            const text = document.getElementById("conn-text");

            if (connected) {
                dot.classList.remove("bg-zinc-600", "bg-red-500");
                dot.classList.add("bg-emerald-500");
                ping.classList.remove("hidden");
                text.innerText = "Live Stream";
                text.classList.add("text-emerald-500");
            } else {
                dot.classList.remove("bg-emerald-500");
                dot.classList.add("bg-red-500");
                ping.classList.add("hidden");
                text.innerText = "Offline";
                text.classList.remove("text-emerald-500");
            }
        }

        // --- MAIN LOGIC (WEB SIDE) ---
        function processSensorData() {
            const s = appState.sensors;

            const t1 = Math.abs(s.mpu1);
            const t2 = Math.abs(s.mpu2);
            const t3 = Math.abs(s.mpu3);
            const maxTilt = Math.max(t1, t2, t3);

            let newStatus = "SAFE";
            let reasons = [];
            let riskLevel = 0; // 0=Safe, 1=Watch, 2=Alert, 3=Danger

            // 0. ESP final landslide logic (3-MPU + soil + rain + vibration + 5s)
            if (appState.landslide) {
                riskLevel = 3;
                reasons.push("ESP landslide pattern detected (3 MPU + soil + rain + vibration, 5s filter).");
            }

            // 1. SoilRisk from ESP
            const soilRiskUpper = appState.soilRiskText.toUpperCase();
            if (soilRiskUpper === "CRITICAL") {
                riskLevel = Math.max(riskLevel, 3);
                reasons.push("ESP SoilRisk = CRITICAL (very wet + unstable slope).");
            } else if (soilRiskUpper.includes("HIGH")) {
                riskLevel = Math.max(riskLevel, 2);
                reasons.push("ESP SoilRisk = " + appState.soilRiskText);
            }

            // 2. Rain logic (NBRO style)
            if (s.rain >= 150) {
                riskLevel = Math.max(riskLevel, 3);
                reasons.push("Rain >150mm (NBRO Evacuation level).");
            } else if (s.rain >= 100) {
                riskLevel = Math.max(riskLevel, 2);
                reasons.push("Rain >100mm (NBRO Alert level).");
            } else if (s.rain >= 75) {
                riskLevel = Math.max(riskLevel, 1);
                reasons.push("Rain >75mm (NBRO Watch level).");
            }

            // 3. Extra soil × slope check (for UI explanation)
            if (s.soil >= 20 && s.soil < 40 && maxTilt > 25) {
                riskLevel = Math.max(riskLevel, 2);
                reasons.push("Moderate: Soil " + Math.round(s.soil) + "% + Slope >25°.");
            } else if (s.soil >= 40 && s.soil < 60 && maxTilt > 25) {
                riskLevel = Math.max(riskLevel, 3);
                reasons.push("High: Soil " + Math.round(s.soil) + "% + Slope >25°.");
            } else if (s.soil >= 60 && maxTilt > 15) {
                riskLevel = Math.max(riskLevel, 3);
                reasons.push("Critical: Soil " + Math.round(s.soil) + "% + Slope >15°.");
            }

            // 4. Pure extreme slope rule
            if (maxTilt > 45) {
                riskLevel = Math.max(riskLevel, 3);
                reasons.push("Extreme Slope Instability (>45°).");
            }

            // Map riskLevel → status
            if (riskLevel === 3) newStatus = "DANGER";
            else if (riskLevel === 2) newStatus = "WARNING";
            else if (riskLevel === 1) newStatus = "WARNING";
            else newStatus = "SAFE";

            // Log status changes
            if (newStatus !== appState.status) {
                if (newStatus === "DANGER" || newStatus === "WARNING" || (appState.status !== "SAFE" && newStatus === "SAFE")) {
                    addLogEntry(newStatus, reasons.join(" ") || "Conditions normalized.");
                }
            }

            appState.status = newStatus;
            updateUI(reasons, maxTilt);
        }

        // --- UI UPDATES ---
        function updateUI(reasons, maxTilt) {
            const s = appState.sensors;

            // MPU cards
            updateMPUCard("mpu1", s.mpu1, s.vib1);
            updateMPUCard("mpu2", s.mpu2, s.vib2);
            updateMPUCard("mpu3", s.mpu3, s.vib3);

            // Soil
            document.getElementById("soil-val").innerText = Math.round(s.soil);
            document.getElementById("soil-bar").style.width = Math.min(100, s.soil) + "%";

            const soilMsg = document.getElementById("soil-risk-text");
            const soilRiskUpper = appState.soilRiskText.toUpperCase();
            let soilHtml = '<span class="text-zinc-300">--</span>';
            if (soilRiskUpper === "CRITICAL") {
                soilHtml = '<span class="text-rose-500 font-bold">CRITICAL</span>';
            } else if (soilRiskUpper.includes("HIGH")) {
                soilHtml = '<span class="text-orange-400 font-semibold">' + appState.soilRiskText + '</span>';
            } else if (soilRiskUpper.includes("MODERATE")) {
                soilHtml = '<span class="text-amber-400">' + appState.soilRiskText + '</span>';
            } else if (soilRiskUpper.includes("LOW")) {
                soilHtml = '<span class="text-emerald-400">' + appState.soilRiskText + '</span>';
            }
            soilMsg.innerHTML = 'Soil risk (ESP): ' + soilHtml;

            // Rain
            document.getElementById("rain-val").innerText = Math.round(s.rain);
            const rStat = document.querySelector("#rain-status span");
            if (s.rain >= 150) {
                rStat.innerText = "Evacuation";
                rStat.className = "text-rose-500 font-bold";
            } else if (s.rain >= 100) {
                rStat.innerText = "Alert";
                rStat.className = "text-orange-400 font-bold";
            } else if (s.rain >= 75) {
                rStat.innerText = "Watch";
                rStat.className = "text-amber-400 font-bold";
            } else {
                rStat.innerText = "Normal";
                rStat.className = "text-zinc-400";
            }

            // Environment
            document.getElementById("temp-val").innerText = s.temp.toFixed(1);
            document.getElementById("humid-val").innerText = Math.round(s.humid);

            // Main status card
            const card = document.getElementById("status-card");
            const txt = document.getElementById("status-display");
            const bar = document.getElementById("risk-bar");
            const msg = document.getElementById("status-msg");
            const overlay = document.getElementById("danger-overlay");

            card.classList.remove("glow-safe", "glow-warning", "glow-danger");

            if (appState.status === "SAFE") {
                card.classList.add("glow-safe");
                txt.innerText = "SAFE";
                txt.className = "text-6xl lg:text-7xl font-bold text-emerald-400 tracking-tighter mt-4";
                bar.className = "h-full bg-emerald-500 transition-all duration-700";
                bar.style.width = "5%";
                msg.innerText = "All sensors within NBRO safety baselines.";
                msg.className = "text-sm text-zinc-400 font-mono border-l-2 border-emerald-500/30 pl-3";
                overlay.classList.remove("animate-danger-overlay", "opacity-30");
                overlay.classList.add("opacity-0");
            } else if (appState.status === "WARNING") {
                card.classList.add("glow-warning");
                txt.innerText = "WARNING";
                txt.className = "text-6xl lg:text-7xl font-bold text-amber-400 tracking-tighter mt-4";
                bar.className = "h-full bg-amber-500 transition-all duration-700";
                bar.style.width = "50%";
                msg.innerText = reasons.join(" ") || "Elevated risk factors detected.";
                msg.className = "text-sm text-zinc-400 font-mono border-l-2 border-amber-500/30 pl-3";
                overlay.classList.remove("animate-danger-overlay", "opacity-30");
                overlay.classList.add("opacity-0");
            } else {
                card.classList.add("glow-danger");
                txt.innerText = "DANGER";
                txt.className = "text-6xl lg:text-7xl font-bold text-rose-500 tracking-tighter mt-4 animate-pulse";
                bar.className = "h-full bg-rose-500 transition-all duration-700";
                bar.style.width = "100%";
                msg.innerText = (reasons.join(" ") || "Critical conditions.") + " EVACUATE.";
                msg.className = "text-sm text-rose-300 font-mono border-l-2 border-rose-500 pl-3 font-bold";
                overlay.classList.remove("opacity-0");
                overlay.classList.add("opacity-30", "animate-danger-overlay");
            }
        }

        function updateMPUCard(idBase, val, vib) {
            const elVal = document.getElementById(idBase + "-val");
            const elStat = document.getElementById(idBase + "-status");
            const elVib = document.getElementById(idBase + "-vib");

            const absVal = Math.abs(val);
            elVal.innerText = absVal.toFixed(1);

            if (absVal > 45) {
                elStat.innerText = "Highly Variable (>45°)";
                elStat.className = "text-[10px] font-mono mt-2 text-rose-400 font-bold";
            } else if (absVal > 35) {
                elStat.innerText = "High Slope (35-45°)";
                elStat.className = "text-[10px] font-mono mt-2 text-orange-400";
            } else if (absVal > 25) {
                elStat.innerText = "Mod-High (25-35°)";
                elStat.className = "text-[10px] font-mono mt-2 text-amber-400";
            } else if (absVal > 15) {
                elStat.innerText = "Low-Mod (15-25°)";
                elStat.className = "text-[10px] font-mono mt-2 text-emerald-200";
            } else {
                elStat.innerText = "Very Low (<15°)";
                elStat.className = "text-[10px] font-mono mt-2 text-emerald-400";
            }

            const vText = (vib || "Low").toString();
            elVib.innerText = "Vibration: " + vText;

            if (vText.toUpperCase() === "HIGH") {
                elVib.className = "mt-1 text-[10px] font-mono inline-block px-2 py-1 rounded bg-rose-500/10 border border-rose-500/40 text-rose-300";
            } else {
                elVib.className = "mt-1 text-[10px] font-mono inline-block px-2 py-1 rounded bg-zinc-900/60 border border-zinc-800 text-zinc-400";
            }
        }

        function addLogEntry(status, message) {
            const log = document.getElementById("alert-log");
            const div = document.createElement("div");
            const time = new Date().toLocaleTimeString("en-US", { hour12: false });

            let colorClass = "text-zinc-400";
            if (status === "DANGER") colorClass = "text-rose-400 font-bold";
            if (status === "WARNING") colorClass = "text-amber-400";
            if (status === "SAFE") colorClass = "text-emerald-400";
            if (status === "TEST") colorClass = "text-indigo-400";

            div.className =
                "flex gap-3 text-xs border-l-2 pl-3 py-1 animate-fade-in " +
                (status === "DANGER" ? "border-rose-500" : "border-zinc-700");

            div.innerHTML =
                <span class="opacity-50 font-mono text-zinc-500">${time}</span> +
                ` <span class="${colorClass}">${status}</span>` +
                ` <span class="text-zinc-300">${message}</span>`;

            log.prepend(div);
        }

        // --- Manual simulation button ---
        document.getElementById("force-danger-btn").addEventListener("click", () => {
            appState.sensors.mpu1 = 28;
            appState.sensors.mpu2 = 26;
            appState.sensors.mpu3 = 10;
            appState.sensors.soil = 65;
            appState.sensors.rain = 120;
            appState.sensors.vib1 = "High";
            appState.sensors.vib2 = "High";
            appState.sensors.vib3 = "High";
            appState.landslide = true;
            appState.soilRiskText = "Critical";

            processSensorData();
            addLogEntry("TEST", "Manual simulation triggered (Landslide=YES, SoilRisk=Critical).");
        });

        // --- Clear log button ---
        document.getElementById("clear-log").addEventListener("click", () => {
            document.getElementById("alert-log").innerHTML =
                '<div class="flex gap-3 text-zinc-600"><span>--:--:--</span><span>Log cleared.</span></div>';
        });
    </script>

</body>
</html>